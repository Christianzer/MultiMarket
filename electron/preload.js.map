{"version":3,"file":"preload.js","sources":["preload.ts"],"sourcesContent":["import { contextBridge, ipcRenderer } from 'electron'\r\n\r\n// Liste des canaux autorisés pour la sécurité\r\nconst ALLOWED_CHANNELS = {\r\n  // IPC Channels\r\n  invoke: [\r\n    'print-receipt',\r\n    'open-dev-tools',\r\n    'window-minimize',\r\n    'window-maximize', \r\n    'window-close',\r\n    'check-for-updates',\r\n    'quit-and-install',\r\n    'get-app-version',\r\n    'restart-app'\r\n  ],\r\n  on: [\r\n    'main-process-message',\r\n    'updater-message',\r\n    'updater-error',\r\n    'updater-progress'\r\n  ],\r\n  send: []\r\n}\r\n\r\n// Validation sécurisée des canaux\r\nfunction validateChannel(channel: string, type: 'invoke' | 'on' | 'send'): boolean {\r\n  return ALLOWED_CHANNELS[type].includes(channel)\r\n}\r\n\r\n// API sécurisée avec validation et limitation de taux\r\nclass SecureElectronAPI {\r\n  private rateLimiter = new Map<string, { count: number; resetTime: number }>()\r\n  private readonly RATE_LIMIT = 10 // 10 appels par seconde maximum\r\n  private readonly RATE_WINDOW = 1000 // 1 seconde\r\n\r\n  private checkRateLimit(channel: string): boolean {\r\n    const now = Date.now()\r\n    const limit = this.rateLimiter.get(channel)\r\n\r\n    if (!limit || now > limit.resetTime) {\r\n      this.rateLimiter.set(channel, { count: 1, resetTime: now + this.RATE_WINDOW })\r\n      return true\r\n    }\r\n\r\n    if (limit.count >= this.RATE_LIMIT) {\r\n      console.warn(`Rate limit exceeded for channel: ${channel}`)\r\n      return false\r\n    }\r\n\r\n    limit.count++\r\n    return true\r\n  }\r\n\r\n  // IPC Communication sécurisé\r\n  on(channel: string, listener: (event: any, ...args: any[]) => void) {\r\n    if (!validateChannel(channel, 'on')) {\r\n      console.error(`Unauthorized channel: ${channel}`)\r\n      return\r\n    }\r\n    return ipcRenderer.on(channel, (event, ...args) => listener(event, ...args))\r\n  }\r\n\r\n  off(channel: string, ...args: any[]) {\r\n    if (!validateChannel(channel, 'on')) {\r\n      console.error(`Unauthorized channel: ${channel}`)\r\n      return\r\n    }\r\n    return ipcRenderer.off(channel, ...args)\r\n  }\r\n\r\n  send(channel: string, ...args: any[]) {\r\n    if (!validateChannel(channel, 'send')) {\r\n      console.error(`Unauthorized channel: ${channel}`)\r\n      return\r\n    }\r\n    if (!this.checkRateLimit(channel)) return\r\n    return ipcRenderer.send(channel, ...args)\r\n  }\r\n\r\n  async invoke(channel: string, ...args: any[]) {\r\n    if (!validateChannel(channel, 'invoke')) {\r\n      console.error(`Unauthorized channel: ${channel}`)\r\n      throw new Error(`Unauthorized channel: ${channel}`)\r\n    }\r\n    if (!this.checkRateLimit(channel)) {\r\n      throw new Error(`Rate limit exceeded for: ${channel}`)\r\n    }\r\n\r\n    const startTime = performance.now()\r\n    try {\r\n      const result = await ipcRenderer.invoke(channel, ...args)\r\n      const duration = performance.now() - startTime\r\n      \r\n      // Log des opérations lentes\r\n      if (duration > 1000) {\r\n        console.warn(`Slow IPC operation: ${channel} took ${duration.toFixed(2)}ms`)\r\n      }\r\n      \r\n      return result\r\n    } catch (error) {\r\n      console.error(`IPC Error on ${channel}:`, error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  // API spécifique avec validation des paramètres\r\n  printReceipt(htmlContent: string) {\r\n    if (typeof htmlContent !== 'string' || htmlContent.length === 0) {\r\n      throw new Error('Invalid HTML content for printing')\r\n    }\r\n    if (htmlContent.length > 1024 * 1024) { // Limite 1MB\r\n      throw new Error('HTML content too large for printing')\r\n    }\r\n    return this.invoke('print-receipt', htmlContent)\r\n  }\r\n\r\n  openDevTools() {\r\n    // Seulement en développement\r\n    if (process.env.NODE_ENV !== 'development') {\r\n      console.warn('DevTools disabled in production')\r\n      return Promise.resolve()\r\n    }\r\n    return this.invoke('open-dev-tools')\r\n  }\r\n\r\n  minimize() {\r\n    return this.invoke('window-minimize')\r\n  }\r\n\r\n  maximize() {\r\n    return this.invoke('window-maximize')\r\n  }\r\n\r\n  close() {\r\n    return this.invoke('window-close')\r\n  }\r\n\r\n  checkForUpdates() {\r\n    return this.invoke('check-for-updates')\r\n  }\r\n\r\n  quitAndInstall() {\r\n    return this.invoke('quit-and-install')\r\n  }\r\n\r\n  getAppVersion() {\r\n    return this.invoke('get-app-version')\r\n  }\r\n\r\n  restartApp() {\r\n    return this.invoke('restart-app')\r\n  }\r\n\r\n  // Event listeners avec nettoyage automatique\r\n  onUpdaterMessage(callback: (message: string) => void) {\r\n    if (typeof callback !== 'function') {\r\n      throw new Error('Callback must be a function')\r\n    }\r\n    this.on('updater-message', (_, message) => {\r\n      if (typeof message === 'string') {\r\n        callback(message)\r\n      }\r\n    })\r\n  }\r\n\r\n  onUpdaterError(callback: (error: string) => void) {\r\n    if (typeof callback !== 'function') {\r\n      throw new Error('Callback must be a function')\r\n    }\r\n    this.on('updater-error', (_, error) => {\r\n      if (typeof error === 'string') {\r\n        callback(error)\r\n      }\r\n    })\r\n  }\r\n\r\n  onUpdaterProgress(callback: (progress: any) => void) {\r\n    if (typeof callback !== 'function') {\r\n      throw new Error('Callback must be a function')\r\n    }\r\n    this.on('updater-progress', (_, progress) => {\r\n      if (progress && typeof progress === 'object') {\r\n        callback(progress)\r\n      }\r\n    })\r\n  }\r\n\r\n  // Méthodes utilitaires\r\n  getSecurityInfo() {\r\n    return {\r\n      allowedChannels: ALLOWED_CHANNELS,\r\n      rateLimits: Object.fromEntries(this.rateLimiter),\r\n      nodeIntegration: false,\r\n      contextIsolation: true,\r\n      sandbox: false // À modifier selon votre configuration\r\n    }\r\n  }\r\n}\r\n\r\n// --------- Expose the secure API to the Renderer process ---------\r\nconst secureAPI = new SecureElectronAPI()\r\ncontextBridge.exposeInMainWorld('electronAPI', secureAPI)\r\n\r\n// --------- Preload scripts loading ---------\r\nfunction domReady(condition: DocumentReadyState[] = ['complete', 'interactive']) {\r\n  return new Promise((resolve) => {\r\n    if (condition.includes(document.readyState)) {\r\n      resolve(true)\r\n    } else {\r\n      document.addEventListener('readystatechange', () => {\r\n        if (condition.includes(document.readyState)) {\r\n          resolve(true)\r\n        }\r\n      })\r\n    }\r\n  })\r\n}\r\n\r\nconst safeDOM = {\r\n  append(parent: HTMLElement, child: HTMLElement) {\r\n    if (!Array.from(parent.children).find(c => c === child)) {\r\n      return parent.appendChild(child)\r\n    }\r\n  },\r\n  remove(parent: HTMLElement, child: HTMLElement) {\r\n    if (Array.from(parent.children).find(c => c === child)) {\r\n      return parent.removeChild(child)\r\n    }\r\n  },\r\n}\r\n\r\n/**\r\n * https://tobiasahlin.com/spinkit\r\n * https://connoratherton.com/loaders\r\n * https://projects.lukehaas.me/css-loaders\r\n * https://matejkustec.github.io/SpinThatShit\r\n */\r\nfunction useLoading() {\r\n  const className = `loaders-css__square-spin`\r\n  const styleContent = `\r\n@keyframes square-spin {\r\n  25% { \r\n    transform: perspective(100px) rotateX(180deg) rotateY(0); \r\n  }\r\n  50% { \r\n    transform: perspective(100px) rotateX(180deg) rotateY(180deg); \r\n  }\r\n  75% { \r\n    transform: perspective(100px) rotateX(0) rotateY(180deg); \r\n  }\r\n  100% { \r\n    transform: perspective(100px) rotateX(0) rotateY(0); \r\n  }\r\n}\r\n.${className} > div {\r\n  animation-fill-mode: both;\r\n  width: 50px;\r\n  height: 50px;\r\n  background: #fff;\r\n  animation: square-spin 3s 0s cubic-bezier(0.09, 0.57, 0.49, 0.9) infinite;\r\n}\r\n.app-loading-wrap {\r\n  position: fixed;\r\n  top: 0;\r\n  left: 0;\r\n  width: 100vw;\r\n  height: 100vh;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  background: #282c34;\r\n  z-index: 9;\r\n}\r\n    `\r\n  const oStyle = document.createElement('style')\r\n  const oDiv = document.createElement('div')\r\n\r\n  oStyle.id = 'app-loading-style'\r\n  oStyle.innerHTML = styleContent\r\n  oDiv.className = 'app-loading-wrap'\r\n  oDiv.innerHTML = `<div class=\"${className}\"><div></div></div>`\r\n\r\n  return {\r\n    appendLoading() {\r\n      safeDOM.append(document.head, oStyle)\r\n      safeDOM.append(document.body, oDiv)\r\n    },\r\n    removeLoading() {\r\n      safeDOM.remove(document.head, oStyle)\r\n      safeDOM.remove(document.body, oDiv)\r\n    },\r\n  }\r\n}\r\n\r\n// ----------------------------------------------------------------------\r\n\r\nconst { appendLoading, removeLoading } = useLoading()\r\ndomReady().then(appendLoading)\r\n\r\nwindow.onmessage = (ev) => {\r\n  ev.data.payload === 'removeLoading' && removeLoading()\r\n}\r\n\r\nsetTimeout(removeLoading, 4999)"],"names":[],"mappings":"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"}